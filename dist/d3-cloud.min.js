!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("d3-dispatch")):"function"==typeof define&&define.amd?define(["d3-dispatch"],n):t.d3=n(t.d3)}(this,function(t){"use strict";var n=Math.PI/180,e=64,r=2048;function a(t){return t.text}function i(){return"serif"}function o(){return"normal"}function u(t){return Math.sqrt(t.value)}function f(){return 30*(~~(6*Math.random())-3)}function c(){return 1}function l(t,a,i,o){if(!a.sprite){var u=t.context,f=t.ratio;u.clearRect(0,0,(e<<5)/f,r/f);var c=0,l=0,h=0,s=i.length;for(--o;++o<s;){a=i[o],u.save(),u.font=a.style+" "+a.weight+" "+~~((a.size+1)/f)+"px "+a.font;var y=u.measureText(a.text+"m").width*f,x=a.size<<1;if(a.rotate){var d=Math.sin(a.rotate*n),v=Math.cos(a.rotate*n),g=y*v,p=y*d,M=x*v,m=x*d;y=Math.max(Math.abs(g+m),Math.abs(g-m))+31>>5<<5,x=~~Math.max(Math.abs(p+M),Math.abs(p-M))}else y=y+31>>5<<5;if(x>h&&(h=x),c+y>=e<<5&&(c=0,l+=h,h=0),l+x>=r)break;u.translate((c+(y>>1))/f,(l+(x>>1))/f),a.rotate&&u.rotate(a.rotate*n),u.fillText(a.text,0,0),a.padding&&(u.lineWidth=2*a.padding,u.strokeText(a.text,0,0)),u.restore(),a.width=y,a.height=x,a.xoff=c,a.yoff=l,a.x1=y>>1,a.y1=x>>1,a.x0=-a.x1,a.y0=-a.y1,a.hasText=!0,c+=y}for(var w=u.getImageData(0,0,(e<<5)/f,r/f).data,b=[];--o>=0;)if((a=i[o]).hasText){for(var z=(y=a.width)>>5,I=(x=a.y1-a.y0,0);I<x*z;I++)b[I]=0;if(null==(c=a.xoff))return;l=a.yoff;for(var k=0,T=-1,q=0;q<x;q++){for(I=0;I<y;I++){var D=z*q+(I>>5),S=w[(l+q)*(e<<5)+(c+I)<<2]?1<<31-I%32:0;b[D]|=S,k|=S}k?T=q:(a.y0++,x--,q--,l++)}a.y1=a.y0+T,a.sprite=b.slice(0,(a.y1-a.y0)*z)}}}function h(t,n,e){e>>=5;for(var r,a=t.sprite,i=t.width>>5,o=t.x-(i<<4),u=127&o,f=32-u,c=t.y1-t.y0,l=(t.y+t.y0)*e+(o>>5),h=0;h<c;h++){r=0;for(var s=0;s<=i;s++)if((r<<f|(s<i?(r=a[h*i+s])>>>u:0))&n[l+s])return!0;l+=e}return!1}function s(t,n){var e=t[0],r=t[1];n.x+n.x0<e.x&&(e.x=n.x+n.x0),n.y+n.y0<e.y&&(e.y=n.y+n.y0),n.x+n.x1>r.x&&(r.x=n.x+n.x1),n.y+n.y1>r.y&&(r.y=n.y+n.y1)}function y(t){var n=t[0]/t[1];return function(t){return[n*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function x(){return document.createElement("canvas")}function d(t){return"function"==typeof t?t:function(){return t}}var v={archimedean:y,rectangular:function(t){var n=4*t[0]/t[1],e=0,r=0;return function(t){var a=t<0?-1:1;switch(Math.sqrt(1+4*a*t)-a&3){case 0:e+=n;break;case 1:r+=4;break;case 2:e-=n;break;default:r-=4}return[e,r]}}};return function(){var n=[256,256],g=a,p=i,M=u,m=o,w=o,b=f,z=c,I=y,k=[],T=1/0,q=t.dispatch("word","end"),D=null,S=Math.random,C=x;function W(){}function j(t,e,r){n[0],n[1];for(var a,i,o,u,f,c=e.x,l=e.y,s=Math.sqrt(n[0]*n[0]+n[1]*n[1]),y=I(n),x=S()<.5?1:-1,d=-x;(a=y(d+=x))&&(i=~~a[0],o=~~a[1],!(Math.min(Math.abs(i),Math.abs(o))>=s));)if(e.x=c+i,e.y=l+o,!(e.x+e.x0<0||e.y+e.y0<0||e.x+e.x1>n[0]||e.y+e.y1>n[1]||r&&h(e,t,n[0])||r&&(f=r,!((u=e).x+u.x1>f[0].x&&u.x+u.x0<f[1].x&&u.y+u.y1>f[0].y&&u.y+u.y0<f[1].y)))){for(var v,g=e.sprite,p=e.width>>5,M=n[0]>>5,m=e.x-(p<<4),w=127&m,b=32-w,z=e.y1-e.y0,k=(e.y+e.y0)*M+(m>>5),T=0;T<z;T++){v=0;for(var q=0;q<=p;q++)t[k+q]|=v<<b|(q<p?(v=g[T*p+q])>>>w:0);k+=M}return delete e.sprite,!0}return!1}return W.initialize=function(t){},W.canvas=function(t){return arguments.length?(C=d(t),W):C},W.start=function(){var t=function(t){t.width=t.height=1;var n=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2);t.width=(e<<5)/n,t.height=r/n;var a=t.getContext("2d");return a.fillStyle=a.strokeStyle="red",a.textAlign="center",{context:a,ratio:n}}(C()),a=function(t){for(var n=[],e=-1;++e<t;)n[e]=0;return n}((n[0]>>5)*n[1]),i=null,o=k.length,u=-1,f=[],c=k.map(function(t,n){return t.text=g.call(this,t,n),t.font=p.call(this,t,n),t.style=m.call(this,t,n),t.weight=w.call(this,t,n),t.rotate=b.call(this,t,n),t.size=~~M.call(this,t,n),t.padding=z.call(this,t,n),t}).sort(function(t,n){return n.size-t.size});return D&&clearInterval(D),D=setInterval(h,0),h(),W;function h(){for(var e=Date.now();Date.now()-e<T&&++u<o&&D;){var r=c[u];r.x=n[0]*(S()+.5)>>1,r.y=n[1]*(S()+.5)>>1,l(t,r,c,u),r.hasText&&j(a,r,i)&&(f.push(r),q.call("word",W,r),i?s(i,r):i=[{x:r.x+r.x0,y:r.y+r.y0},{x:r.x+r.x1,y:r.y+r.y1}],r.x-=n[0]>>1,r.y-=n[1]>>1)}u>=o&&(W.stop(),q.call("end",W,f,i))}},W.stop=function(){return D&&(clearInterval(D),D=null),W},W.timeInterval=function(t){return arguments.length?(T=null==t?1/0:t,W):T},W.words=function(t){return arguments.length?(k=t,W):k},W.size=function(t){return arguments.length?(n=[+t[0],+t[1]],W):n},W.font=function(t){return arguments.length?(p=d(t),W):p},W.fontStyle=function(t){return arguments.length?(m=d(t),W):m},W.fontWeight=function(t){return arguments.length?(w=d(t),W):w},W.rotate=function(t){return arguments.length?(b=d(t),W):b},W.text=function(t){return arguments.length?(g=d(t),W):g},W.spiral=function(t){return arguments.length?(I=v[t]||t,W):I},W.fontSize=function(t){return arguments.length?(M=d(t),W):M},W.padding=function(t){return arguments.length?(z=d(t),W):z},W.random=function(t){return arguments.length?(S=t,W):S},W.on=function(){var t=q.on.apply(q,arguments);return t===q?W:t},W}});
